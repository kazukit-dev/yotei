# Yotei Development Guidelines

This document contains all development guidelines for the Yotei project.

## üö® Critical: Workspace Verification Process

**MANDATORY**: After completing any development work, always run the following verification sequence:

```bash
pnpm run fix:all && pnpm run check:all && pnpm run test:all
```

This ensures code quality, consistency, and prevents regressions. See [Workspace Quality Assurance](#workspace-quality-assurance) for detailed information.

## General Coding Standards

- Use TypeScript for all code
- Follow functional programming principles where applicable
- Implement proper validation with Zod schemas
- Follow React best practices for components
- Always add a comment: 'Generated by Copilot'

### TypeScript Standards

- **Strict Type Safety**: Enable strict TypeScript settings
- **Prohibited Types**: Never use `any` type - use proper typing instead
- **Type Alternatives**: Use union types, generics, or `unknown` when type is uncertain
- **Type Definitions**: Define explicit interfaces and types for all data structures

#### Examples of Proper Typing

```typescript
// Generated by Copilot
// ‚ùå Wrong: Using any
function processData(data: any): any {
  return data.someProperty;
}

// ‚úÖ Correct: Using proper types
interface UserData {
  id: string;
  name: string;
  email: string;
}

function processUserData(data: UserData): string {
  return data.name;
}

// ‚úÖ Correct: Using generics for unknown types
function processGenericData<T>(data: T): T {
  return data;
}

// ‚úÖ Correct: Using unknown for truly unknown data
function processUnknownData(data: unknown): string {
  if (typeof data === "object" && data !== null && "name" in data) {
    return String(data.name);
  }
  return "Unknown";
}
```

## API Development Guidelines

### Error Handling

- Use neverthrow Result types for error handling in API
- Handle errors gracefully with neverthrow

### Validation

- Validate all inputs with Zod
- Use proper HTTP status codes

### Testing & Validation

- **Mandatory for API changes**: Run `pnpm run test:api` and `pnpm run check:api`
- Always run tests after making API changes: `pnpm test:all`

## Frontend Development Guidelines

### Components

- Use Remix conventions for routing and data loading
- Implement proper loading states
- Use React Aria Components for accessibility
- Follow component composition patterns

### Styling

- Use Tailwind CSS for styling
- Follow consistent naming conventions

## Command Execution Guidelines

### Working Directory

- **Always execute commands from the project root directory**: `/Users/kazuki/developments/yotei/`
- Use workspace-aware commands to target specific apps/packages
- Avoid navigating to subdirectories to run commands

### Command Structure

```bash
# From project root - CORRECT
pnpm run test:api
pnpm run check:api
pnpm --filter ./apps/api test

# From subdirectory - AVOID
cd apps/api && pnpm test
```

## Package Management Guidelines

### pnpm Workspace

- Use pnpm as the package manager for the monorepo
- Leverage workspace protocol (`workspace:*`) for internal dependencies
- Manage dependencies at the appropriate level (root vs app-specific)

### Dependency Management

- **Root dependencies**: Shared tools (ESLint, Prettier, TypeScript)
- **App-specific dependencies**: Framework-specific packages in respective apps
- **Package dependencies**: Utilities and shared configurations in packages/

### Commands

- Install dependencies: `pnpm install`
- Add dependency to specific app: `pnpm --filter ./apps/api add <package>`
- Add dev dependency: `pnpm --filter ./apps/api add -D <package>`
- Remove dependency: `pnpm --filter ./apps/api remove <package>`
- Update dependencies: `pnpm update`
- Run scripts in specific app: `pnpm --filter ./apps/api <script>`

### Root Workspace Operations

- Add root dependency (shared tools): `pnpm add -w <package>`
- Add root dev dependency: `pnpm add -D -w <package>`
- Remove root dependency: `pnpm remove -w <package>`
- Run script in all workspaces: `pnpm -r <script>`
- Run script in all workspaces (parallel): `pnpm -r --parallel <script>`
- Install dependencies for all workspaces: `pnpm install`
- Update all workspace dependencies: `pnpm update -r`

### Workspace Structure

- `apps/api/` - Backend API application
- `apps/web/` - Frontend web application
- `packages/eslint-config/` - Shared ESLint configurations

## Database Guidelines

### ORM

- Use Drizzle ORM for database operations
- Write migrations for schema changes
- Follow naming conventions for tables and columns

### Migrations

- Generate migrations with Drizzle Kit
- Test migrations locally before deployment

## Testing Guidelines

For comprehensive testing guidelines, strategies, and best practices, see: **[Testing Guidelines](./testing.md)**

### Quick Reference

- **Focus**: Test domain objects and workflows primarily
- **File naming**: Use `*.spec.ts` pattern only (`.test.ts` is prohibited)
- **File location**: Colocate test files with source files
- **Commands**: `pnpm run test:api` and `pnpm run check:api` for API development

## Architecture Patterns

### Backend

- Domain-Driven Design: Features organized by domain modules
- Workflow Pattern: Business logic encapsulated in workflows
- Repository Pattern: Data access layer abstraction
- Clean Architecture: Clear separation of concerns

### Frontend

- Component-Based: Reusable UI components
- File-Based Routing: Remix routing conventions
- API Client Layer: Centralized API communication
- Query Management: TanStack Query for server state

## Workspace Quality Assurance

### Standard Verification Process

After completing any development work, **ALWAYS** run the following commands in sequence to ensure code quality and project health:

```bash
# 1. Fix all code quality issues automatically
pnpm run fix:all

# 2. Verify code quality across workspace
pnpm run check:all

# 3. Run all tests to ensure functionality
pnpm run test:all
```

### Available Commands

#### Workspace-wide Commands

- `pnpm run fix:all` - Auto-fix formatting and linting issues across all packages
- `pnpm run check:all` - Run lint, format, and type checks across all packages
- `pnpm run test:all` - Execute all tests across all packages
- `pnpm run dev:all` - Start development servers for all apps

#### Package-specific Commands

- `pnpm run fix:api` - Auto-fix issues in API package only
- `pnpm run fix:web` - Auto-fix issues in Web package only
- `pnpm run check:api` - Quality checks for API package only
- `pnpm run check:web` - Quality checks for Web package only
- `pnpm run test:api` - Run API tests only

### Quality Check Components

#### 1. Fix Commands (`fix:all` / Package-specific)

- **Prettier**: Automatic code formatting
- **ESLint**: Auto-fixable linting issues
- **Purpose**: Ensures consistent code style
- **Examples**: `fix:all`, `fix:api`, `fix:web`

#### 2. Check Commands (`check:all` / Package-specific)

- **`lint:check`**: ESLint rule validation
- **`format:check`**: Prettier formatting validation
- **`typecheck`**: TypeScript compilation validation
- **Purpose**: Verifies code quality standards
- **Examples**: `check:all`, `check:api`, `check:web`

#### 3. Test Commands (`test:all` / Package-specific)

- **Unit Tests**: Domain objects and workflows
- **Integration Tests**: Component interactions
- **Purpose**: Ensures functionality and prevents regressions
- **Examples**: `test:all`, `test:api`

### Workflow Integration

This verification process should be integrated into your development workflow:

1. **During Development**: Use package-specific commands like `pnpm run fix:api` or `pnpm run fix:web` for quick fixes
2. **Before Commits**: Run the full verification process
3. **CI/CD Integration**: These commands are used in automated pipelines
4. **Code Reviews**: All changes must pass these checks

### Expected Results

All commands should complete successfully:

- ‚úÖ **fix:all**: No output indicates successful fixes
- ‚úÖ **check:all**: "All matched files use Prettier code style!" and no ESLint/TypeScript errors
- ‚úÖ **test:all**: All tests pass (e.g., "132/132 tests passed")

### Troubleshooting

If any command fails:

1. **Fix Issues**: Address the specific errors reported
2. **Re-run**: Execute the failed command again
3. **Iterate**: Repeat until all checks pass
4. **Seek Help**: If persistent issues, consult team or documentation
